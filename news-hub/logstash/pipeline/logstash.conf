input {
kafka {
bootstrap_servers => "kafka:9092"
topics => ["news_topic"]
auto_offset_reset => "latest"
decorate_events => true
codec => json
}
}


filter {
# message 필드(JSON) → 루트로 승격
if [message] {
json { source => "message" target => "@parsed" }
if [@parsed] { mutate { rename => { "@parsed" => "doc" } } }
}


# 날짜 파싱
date {
match => [ "[doc][published_at]", "ISO8601", "UNIX", "yyyy-MM-dd HH:mm:ss", "EEE, dd MMM yyyy HH:mm:ss Z" ]
target => "@timestamp"
timezone => "Asia/Seoul"
}


mutate {
# 인덱스 라우팅을 위한 타입/소스 표준화
add_field => { "source_type" => "%{[doc][source_type]}" }
add_field => { "source_site" => "%{[doc][source]}" }
remove_field => ["message", "headers"]
}
}


output {
elasticsearch {
hosts => ["http://elasticsearch:9200"]
index => "news-%{+YYYY.MM.dd}"
document_id => "%{[doc][id]}"
}
stdout { codec => rubydebug }
}